<!DOCTYPE html>
<html>
http://www.imergis.nl/asp/47.asp
http://stackoverflow.com/questions/5387042/best-way-to-overlay-an-esri-shapefile-on-google-maps
https://developers.google.com/maps/documentation/javascript/examples/layer-kml
<head>
    <title>Final Project</title>
    <meta charset="utf-8">
    <link href=bootstrap-3.1.1-dist/css/bootstrap.css rel=stylesheet media="screen">

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBH5IVSW7cKqUUoCyG_jbEXvpx4hyBo0Zc"></script>
    <script src=jquery-2.1.1.js></script>
    <script src=bootstrap-3.1.1-dist/js/bootstrap.min.js></script>
    <script src=jquery.csv-0.71.js></script>
    <script type="text/javascript">
        var geoXml = null;
        var geoXmlDoc = null;
        var stops = [[52.011826, 4.541892],[52.001012, 4.525712],[52.005425, 4.539274]];
        var gemeente = [[52.011826, 4.541892],[52.001012, 4.525712],[52.005425, 4.539274],[52.011826, 4.541892]];
        var gemeenteCoords = [];
        //var provincieCoords = [];
        var markers = [];
        var googleMap;
        var infoWindow;
        var provinciePolygons = [];
        var gemeentePolygons = [];
        var currentActivePolygons;
        var markersVisible = true;

        var provincieFileName = "provinciesConverted.csv";
        var gemeenteFileName = "gemeenten.csv";
        // last nine columns of gemeenteFile do not hold long/lat coords
        function readData(fileName, provincieBool) {
          $(document).ready(function() {
              $.ajax({
                  type: "GET",
                  url: fileName,
                  dataType: "text",
                  success: function(data) {processData(data, provincieBool);}
               });
          });
        }

        // Process data from resultgeneral into dropdown
        function processData(allText, provincieBool) {
            var parsedInput = $.csv.toArrays(allText);
            var coords = [];
            var output = [[]];
            var firstRow = parsedInput[0];
            var previousProvincie = "";
            var previousGemeente = "";
            var row;
            if(provincieBool) {
              previousProvincie = firstRow[firstRow.length-1];
              for(j=0;j<firstRow.length-1;j+=2) {
                var temp = new google.maps.LatLng(firstRow[j+1], firstRow[j]);
                coords.push(temp);
              }
              output.push(coords);
              coords = [];
            }
            else {
              previousProvincie = firstRow[firstRow.length-2];
              previousGemeente = firstRow[firstRow.length-1];
              for(j=0;j<firstRow.length-2;j+=2) {
                var temp = new google.maps.LatLng(firstRow[j+1], firstRow[j]);
                coords.push(temp);
              }
              output.push(coords);
              coords = [];
            }
            for(i=1;i<parsedInput.length;i++) {
              row = parsedInput[i];
              if(provincieBool) {
                if(previousProvincie == row[row.length-1]) {
                  // Do nothing because the provincies are still the same
                  console.log("previousProvincie: " + previousProvincie);
                }
                else {
                  createPolygons(output, provincieBool, i, null, previousProvincie);
                  output = [[]];
                  previousProvincie = row[row.length-1];
                }
                for(j=0;j<row.length-1;j+=2) {
                  var temp = new google.maps.LatLng(row[j+1], row[j]);
                  coords.push(temp);
                }
                output.push(coords);
                coords = [];
              }
              else {
                if(previousGemeente == row[row.length-1] && previousProvincie == row[row.length-2]) {
                  console.log("previousGemeente: " + previousGemeente);
                  // Do nothing because it is still the same gemeente.
                }
                else {
                  createPolygons(output, provincieBool, i, previousGemeente, previousProvincie);
                  var output = [[]];
                  previousProvincie = row[row.length-2];
                  previousGemeente = row[row.length-1];
                }
                for(j=0;j<row.length-2;j+=2) {
                  var temp = new google.maps.LatLng(row[j+1], row[j]);
                  coords.push(temp);
                }
                output.push(coords);
                coords = [];
              }
            }
            if(provincieBool) {
              createPolygons(output, provincieBool, i, null, row[row.length-1]);
            }
            else {
              createPolygons(output, provincieBool, i, row[row.length-1], row[row.length-2]);
            }
        }

      function createPolygons(data, provincieBool, i, gemeente, provincie) {
        // Construct the polygon.
        var polygon = new google.maps.Polygon({
          paths: data,
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.35,
          index: i,
          gemeente: gemeente,
          provincie: provincie
        });
        google.maps.event.addListener(polygon, 'click', function () {
          console.log(this.index);
          console.log(this.gemeente);
          console.log(this.provincie);
          fillPopup(this);
        });
        google.maps.event.addListener(polygon, 'mouseover', function () {
          this.setOptions({
            strokeColor: '#000000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#000000',
            fillOpacity: 0.35
           });          
        });
        google.maps.event.addListener(polygon,"mouseout",function(){
          this.setOptions({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.35
          });
        });
        if(provincieBool) {
          polygon.setMap(googleMap);
          provinciePolygons.push(polygon);
        }
        else {
          polygon.setMap(null);
          gemeentePolygons.push(polygon);
        }
      }

        //var map;
      function initialize() {
        var mapOptions = {
          center: { lat: 52.011826, lng: 4.541892},
          zoom: 8
        };
        googleMap = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
        readData(provincieFileName, true);
        readData(gemeenteFileName, false);
        currentActivePolygons = "Provincies";
        initializeMarkers();
        infoWindow = new google.maps.InfoWindow();

        showMarkers();
      }
      
      function convertGemeenteToCoords() {
        for(i=0;i<gemeente.length;i++) {
            var temp = new google.maps.LatLng(gemeente[i][0], gemeente[i][1]);
            gemeenteCoords.push(temp);
        }
      }

      /** @this {google.maps.Polygon} */
    function fillPopup(polygon) {
      // Replace the info window's content and position.
      if(polygon.gemeente == null) {
        infoWindow.setContent("Provincie: " + polygon.provincie);
      }
      else {
        infoWindow.setContent("Provincie: " + polygon.provincie + "\n" + "Gemeente: " + polygon.gemeente);
      }
      infoWindow.setPosition(this.latLng);

      infoWindow.open(googleMap);
    }

    function switchPolygonViewing (polygonMode) {
      if(polygonMode == currentActivePolygons) {
        // Do nothing
      }
      else if(polygonMode == "Provincies") {
        showProvinciePolygons();
        hideGemeentePolygons();
        currentActivePolygons = "Provincies";
      }
      else if(polygonMode == "Gemeenten") {
        hideProvinciePolygons();
        showGemeentePolygons();
        currentActivePolygons = "Gemeenten";
      }
      else {
        // None has been selected, hide all
        hideProvinciePolygons();
        hideGemeentePolygons();
        currentActivePolygons = "None";
      }
    }

    function showProvinciePolygons() {
      for(i=0;i<provinciePolygons.length;i++) {
            provinciePolygons[i].setMap(googleMap);
      }
    }

    function showGemeentePolygons() {
      for(i=0;i<gemeentePolygons.length;i++) {
          gemeentePolygons[i].setMap(googleMap);
      }
    }

      function hideProvinciePolygons() {
        for(i=0;i<provinciePolygons.length;i++) {
            provinciePolygons[i].setMap(null);
        }
      }

      function hideGemeentePolygons() {
        for(i=0;i<gemeentePolygons.length;i++) {
          gemeentePolygons[i].setMap(null);
        }
      }

      function initializeMarkers() {
        for (i = 0; i<stops.length;i++) {
            var temp = new google.maps.Marker({
                position: new google.maps.LatLng(stops[i][0],stops[i][1]),
                title: "busStop" + i,
            });
            markers.push(temp);
        }
      }

      function showMarkers() {
        for(i = 0;i<markers.length;i++) {
            var marker = markers[i];
            marker.setMap(googleMap);
        }
      }

      function hideMarkers() {
        for(i = 0;i<markers.length;i++) {
            var marker = markers[i];
            marker.setMap(null);
        }
      }

      function switchVisibilityMarkers() {
        if(markersVisible) {
          hideMarkers();
          markersVisible = false;
        }
        else {
          showMarkers();
          markersVisible = true;
        }
      }

      // On click for the dropdown
      $(function(){
        $("#menuTime").on('click', 'li a', function() {
            $("#dropdownMenu2").val($(this).text());
            $("#dropdownMenu2").html($(this).text() + ' <span class="caret"></span>');
            console.log($(this).text());
            switchPolygonViewing($(this).text());
        });
    });

      //google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<style>
#map-canvas {
    height: 600px;
    width: 1100px; 
    margin-left: auto; 
    margin-right: auto; 
}

.jumbotronPadding{
    padding: 30px 15px;
    margin-top: 80px;
}
.navbar-nav li input {
 line-height: 20px;
}
</style>

<!--<div id='editor'></div>-->


<body onload="initialize()">
    <div class="container">
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
              <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">OpenOV Visualization</a>
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                  <ul class="nav navbar-nav navbar-right">
                    <li>
                        <div>
                        <p class="navbar-text">Datasets:</p>
                        </div>
                    </li>
                    <li>
                        <div class="btn-group navbar-btn">
                          <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-expanded="true">
                          Provincies
                          <span class="caret"></span>
                          </button>
                          <ul class="dropdown-menu" id="menuTime" role="menu" aria-labelledby="dropdownMenu2">
                              <li role = "presentation"><a role="menuitem" tabindex="-1">Gemeenten</a></li>
                              <li role = "presentation"><a role="menuitem" tabindex="-1">Provincies</a></li>
                              <li role = "presentation"><a role="menuitem" tabindex="-1">None</a></li>
                          </ul>
                        </div>
                    </li>
                    <li>
                      <div class="checkbox navbar-text">
                          <label class="navbar-link" for="filterUnfulfilled">
                              <input class="autosubmit" id="filterUnfulfilled" value="true" type="checkbox" onchange="switchVisibilityMarkers()" checked>
                              Show/Hide markers
                          </label>
                      </div>
                    </li>
                  </ul>
                </div>
        </nav>

        <div class="container col-centered">
            <div class="jumbotron jumbotronPadding">
                <h1>OpenOV visualization</h1>
                <h4>Authors: Friso Abcouwer (4019873) & Marijn Goedegebure (4013484)</h4>
            </div>
        </div>
        <div class="container col-centered">
            <div class="row">
                <div id="map-canvas"></div>
            </div>
        </div>
    </div>
    <div id="footer" style="height:50px">
    </div>
</body>
</html>