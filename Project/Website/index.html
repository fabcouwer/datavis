<!DOCTYPE html>
<html>
http://www.imergis.nl/asp/47.asp
http://stackoverflow.com/questions/5387042/best-way-to-overlay-an-esri-shapefile-on-google-maps
https://developers.google.com/maps/documentation/javascript/examples/layer-kml
<head>
    <title>Final Project</title>
    <meta charset="utf-8">
    <link href=bootstrap-3.1.1-dist/css/bootstrap.css rel=stylesheet media="screen">

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBH5IVSW7cKqUUoCyG_jbEXvpx4hyBo0Zc"></script>
    <script src=jquery-2.1.1.js></script>
    <script src=bootstrap-3.1.1-dist/js/bootstrap.min.js></script>
    <script src=jquery.csv-0.71.js></script>
    <script type="text/javascript">
        var geoXml = null;
        var geoXmlDoc = null;
        var stops = [[52.011826, 4.541892],[52.001012, 4.525712],[52.005425, 4.539274]];
        var gemeente = [[52.011826, 4.541892],[52.001012, 4.525712],[52.005425, 4.539274],[52.011826, 4.541892]];
        var gemeenteCoords = [];
        //var provincieCoords = [];
        var provincieMarkers = [];
        var gemeenteMarkers = [];
        var googleMap;
        var infoWindow;
        var provinciePolygons = [];
        var gemeentePolygons = [];
        var currentActivePolygons;
        var currentlySelectedPolygon = null;
        var markersVisible = true;
        var ready = false;

        var provincieFileName = "provincies.csv";
        var gemeenteFileName = "gemeenten.csv";
        var stopsFileName = "markerData.csv";
        var statisticsProvincieFileName = "perProvincie v2.csv";
        var statisticsGemeenteFileName = "municipalityData v4.csv";
        // last nine columns of gemeenteFile do not hold long/lat coords
        function readData(fileName, provincieBool) {
          $(document).ready(function() {
              $.ajax({
                  type: "GET",
                  url: fileName,
                  dataType: "text",
                  success: function(data) {processData(data, provincieBool);}
               });
          });
        }

        function readStops(fileName) {
          $(document).ready(function() {
              $.ajax({
                  type: "GET",
                  url: fileName,
                  dataType: "text",
                  success: function(data) {processStops(data);}
               });
          });
        }

        function readStatisticsProvincie(fileName) {
          $(document).ready(function() {
              $.ajax({
                  type: "GET",
                  url: fileName,
                  dataType: "text",
                  success: function(data) {processProvincieStatistics(data);}
               });
          });
        }

        function readStatisticsGemeente(fileName) {
          $(document).ready(function() {
              $.ajax({
                  type: "GET",
                  url: fileName,
                  dataType: "text",
                  success: function(data) {processGemeenteStatistics(data);}
               });
          });
        }

        function processProvincieStatistics(data) {
          var parsedInput = $.csv.toArrays(data);
          for(i = 1;i<parsedInput.length;i++) {
            for(j = 0; j < provinciePolygons.length;j++) {
              if(parsedInput[i][1] == provinciePolygons[j].provincie) {
                provinciePolygons[j].population = parsedInput[i][3];
                provinciePolygons[j].popPerKm2 = parsedInput[i][4];
                provinciePolygons[j].numberOfStops = parsedInput[i][5];
                provinciePolygons[j].numberOfRoutes = parsedInput[i][6];
              }
            }
          }
        }

        function processGemeenteStatistics(data) {
          var parsedInput = $.csv.toArrays(data);
          for(i = 1;i<parsedInput.length;i++) {
            for(j = 0; j < gemeentePolygons.length;j++) {
              if(parsedInput[i][1] == gemeentePolygons[j].gemeente) {
                gemeentePolygons[j].population = parsedInput[i][3];
                gemeentePolygons[j].popPerKm2 = parsedInput[i][4];
                gemeentePolygons[j].numberOfStops = parsedInput[i][5];
                gemeentePolygons[j].numberOfRoutes = parsedInput[i][6];
              }
            }
          }
        }

        function processStops(data) {
          var parsedInput = $.csv.toArrays(data);
          for(i = 1; i<parsedInput.length;i++) {
            var temp = new google.maps.Marker({
              position: new google.maps.LatLng(parsedInput[i][3],parsedInput[i][4]),
              title: parsedInput[i][2],
              name: parsedInput[i][2],
              operator: parsedInput[i][1],
              town: parsedInput[i][5],
              gemeente: parsedInput[i][6],
              provincie: parsedInput[i][7],
              routes: parsedInput[i][8]
            });
            google.maps.event.addListener(temp, 'click', function () {
              fillPopupMarker(this);
            });
            var gemeente = null;
            for(j = 0; j<gemeenteMarkers.length; j++) {
              if(gemeenteMarkers[j].name == temp.gemeente) {
                gemeente = gemeenteMarkers[j];
                break;
              }
            }
            if (gemeente == null) {
              gemeente = {
                markers: [temp],
                name: parsedInput[i][6]
              };
              gemeenteMarkers.push(gemeente);
            }
            else {
              gemeente.markers.push(temp);
            }
          }
        }

        // Process data from resultgeneral into dropdown
        function processData(allText, provincieBool) {
            var parsedInput = $.csv.toArrays(allText);
            var coords = [];
            var output = [];
            var firstRow = parsedInput[0];
            var previousProvincie = "";
            var previousGemeente = "";
            var row;
            if(provincieBool) {
              previousProvincie = firstRow[firstRow.length-1];
              for(j=0;j<firstRow.length-1;j+=2) {
                var temp = new google.maps.LatLng(firstRow[j+1], firstRow[j]);
                coords.push(temp);
              }
              output.push(coords);
              coords = [];
            }
            else {
              previousProvincie = firstRow[firstRow.length-1];
              previousGemeente = firstRow[firstRow.length-2];
              for(j=0;j<firstRow.length-2;j+=2) {
                var temp = new google.maps.LatLng(firstRow[j+1], firstRow[j]);
                coords.push(temp);
              }
              output.push(coords);
              coords = [];
            }
            for(i=1;i<parsedInput.length;i++) {
              row = parsedInput[i];
              if(provincieBool) {
                if(previousProvincie == row[row.length-1]) {
                  // Do nothing because the provincies are still the same
                }
                else {
                  createPolygons(output, provincieBool, i, null, previousProvincie);
                  output = [];
                  previousProvincie = row[row.length-1];
                }
                for(j=0;j<row.length-1;j+=2) {
                  var temp = new google.maps.LatLng(row[j+1], row[j]);
                  coords.push(temp);
                }
                output.push(coords);
                coords = [];
              }
              else {
                if(previousGemeente == row[row.length-2] && previousProvincie == row[row.length-1]) {
                  // Do nothing because it is still the same gemeente.
                }
                else {
                  createPolygons(output, provincieBool, i, previousGemeente, previousProvincie);
                  var output = [];
                  previousProvincie = row[row.length-1];
                  previousGemeente = row[row.length-2];
                }
                for(j=0;j<row.length-2;j+=2) {
                  var temp = new google.maps.LatLng(row[j+1], row[j]);
                  coords.push(temp);
                }
                output.push(coords);
                coords = [];
              }
            }
            if(provincieBool) {
              createPolygons(output, provincieBool, i, null, row[row.length-1]);
            }
            else {
              createPolygons(output, provincieBool, i, row[row.length-2], row[row.length-1]);
            }
            ready = true;
        }

      function createPolygons(data, provincieBool, i, gemeente, provincie) {
        // Calculate center
        var bounds = new google.maps.LatLngBounds();
        for(i = 0; i < data.length;i++ ) {
          row = data[i];
          for(j = 0; j < row.length; j++) {
            bounds.extend(row[j]);
          }
        }

        // Construct the polygon.
        var polygon = new google.maps.Polygon({
          paths: data,
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#000000',
          fillOpacity: 0.0,
          index: i,
          gemeente: gemeente,
          provincie: provincie,
          infoWindowPos: bounds.getCenter(),
          population: 0,
          popPerKm2: 0,
          numberOfStops: 0,
          numberOfRoutes: 0
        });
        google.maps.event.addListener(polygon, 'click', function () {
          hideMarkers();
          fillPopup(this);
          showMarkers(this.gemeente, this.provincie);
          currentlySelectedPolygon = this;
        });
        google.maps.event.addListener(polygon, 'mouseover', function () {
          this.setOptions({
            strokeColor: '#000000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#000000',
            fillOpacity: 0.35
           });          
        });
        google.maps.event.addListener(polygon,"mouseout",function(){
          this.setOptions({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#000000',
            fillOpacity: 0.0
          });
        });
        if(provincieBool) {
          polygon.setMap(googleMap);
          provinciePolygons.push(polygon);
        }
        else {
          polygon.setMap(null);
          gemeentePolygons.push(polygon);
        }
      }

      var check = function() {
          if (ready === true) {
            readStatisticsProvincie(statisticsProvincieFileName);
            readStatisticsGemeente(statisticsGemeenteFileName);
             return;
          }
          setTimeout(check, 500);
      }

      check();

        //var map;
      function initialize() {
        var mapOptions = {
          center: { lat: 52.011826, lng: 4.541892},
          zoom: 8
        };
        googleMap = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
        google.maps.event.addListener(googleMap, 'zoom_changed', function() {
          if(googleMap.getZoom() < 10) {
            hideMarkers();
          }
          else {
            showMarkers(currentlySelectedPolygon.gemeente, currentlySelectedPolygon.provincie);
          }
        })
        readData(provincieFileName, true);
        readData(gemeenteFileName, false);
        readStops(stopsFileName);
        currentActivePolygons = "Provincies";
        infoWindow = new google.maps.InfoWindow({
          width: 400
        });
      }
      
      function convertGemeenteToCoords() {
        for(i=0;i<gemeente.length;i++) {
            var temp = new google.maps.LatLng(gemeente[i][0], gemeente[i][1]);
            gemeenteCoords.push(temp);
        }
      }

      function fillPopupMarker(marker) {
        infoWindow.setContent(
          "<div id='infoWindow'>" +
          "Name of stop: " + marker.name + "<br>" +
          "Provincie: " + marker.provincie + "<br>" +
          "Gemeente: " + marker.gemeente + "<br>" +
          "Town: " + marker.town + "<br>" +
          "Routes: " + marker.routes + "<br>" +
          "Operators: " + marker.operator + "<br>" +
          "</div>"
        );
        infoWindow.setPosition(marker.position);
        infoWindow.open(googleMap);
      }

      /** @this {google.maps.Polygon} */
    function fillPopup(polygon) {
      // Replace the info window's content and position.
      if(polygon.gemeente == null) {
        infoWindow.setContent(
          "<div id='infoWindow'>" +
          "Provincie: " + polygon.provincie + "<br>" +
          "Population: " + polygon.population + "<br>" +
          "Population per km2: " + polygon.popPerKm2 + "<br>" +
          "Number of stops: " + polygon.numberOfStops + "<br>" +
          "Number of stops per person: " + (polygon.numberOfStops/polygon.population).toFixed(5) + "<br>" +
          "Number of stops per km2: " + (polygon.numberOfStops/(polygon.population/polygon.popPerKm2)).toFixed(5) + "<br>" +
          "Number of routes: " + polygon.numberOfRoutes + "<br>" +
          "</div>"
          );
      }
      else {
        infoWindow.setContent(
          "<div id = 'infoWindow'>" +
          "Provincie: " + polygon.provincie + "<br>" +
          "Gemeente: " + polygon.gemeente + "<br>" +
          "Population: " + polygon.population + "<br>" +
          "Population per km2: " + polygon.popPerKm2 + "<br>" +
          "Number of stops: " + polygon.numberOfStops + "<br>" +
          "Number of stops per person: " + (polygon.numberOfStops/polygon.population).toFixed(5) + "<br>" +
          "Number of stops per km2: " + (polygon.numberOfStops/(polygon.population/polygon.popPerKm2)).toFixed(5) + "<br>" +
          "Number of routes: " + polygon.numberOfRoutes + "<br>" +
          "</div>"
        );
      }
      infoWindow.setPosition(polygon.infoWindowPos);

      infoWindow.open(googleMap);
    }

    function switchPolygonViewing (polygonMode) {
      if(polygonMode == currentActivePolygons) {
        // Do nothing
      }
      else if(polygonMode == "Provincies") {
        showProvinciePolygons();
        hideGemeentePolygons();
        currentActivePolygons = "Provincies";
      }
      else if(polygonMode == "Gemeenten") {
        hideProvinciePolygons();
        showGemeentePolygons();
        currentActivePolygons = "Gemeenten";
      }
      else {
        // None has been selected, hide all
        hideProvinciePolygons();
        hideGemeentePolygons();
        currentActivePolygons = "None";
      }
    }

    function showProvinciePolygons() {
      for(i=0;i<provinciePolygons.length;i++) {
            provinciePolygons[i].setMap(googleMap);
      }
    }

    function showGemeentePolygons() {
      for(i=0;i<gemeentePolygons.length;i++) {
          gemeentePolygons[i].setMap(googleMap);
      }
    }

      function hideProvinciePolygons() {
        for(i=0;i<provinciePolygons.length;i++) {
            provinciePolygons[i].setMap(null);
        }
      }

      function hideGemeentePolygons() {
        for(i=0;i<gemeentePolygons.length;i++) {
          gemeentePolygons[i].setMap(null);
        }
      }

      function showMarkers(gemeente, provincie) {
        if(googleMap.getZoom() > 10) {
          if(gemeente == null) {
            var index = -1;
            for(i = 0;i<provincieMarkers.length;i++) {
              if(provincie == provincieMarkers[i].name) {
                index = i;
              }
            }
            if(index>-1) {
              var provincie = provincieMarkers[index];
              for(i = 0;i< provincie.markers.length;i++) {
                var marker = provincie.markers[i];
                marker.setMap(googleMap);
              }
            }
          }
          else {
            var index = -1;
            for(i = 0;i<gemeenteMarkers.length;i++) {
              if(gemeente == gemeenteMarkers[i].name) {
                index = i;
              }
            }
            if(index>-1) {
              var gemeente = gemeenteMarkers[index];
              for(i = 0;i< gemeente.markers.length;i++) {
                var marker = gemeente.markers[i];
                marker.setMap(googleMap);
              }
            }
          }
        }
      }

      function hideMarkers() {
        if(currentlySelectedPolygon != null) {
          if(currentlySelectedPolygon.gemeente == null) {
            var index = -1;
            for(i = 0;i<provincieMarkers.length;i++) {
              if(currentlySelectedPolygon.provincie == provincieMarkers[i].name) {
                index = i;
              }
            }
            if(index>-1) {
              var provincie = provincieMarkers[index];
              for(i = 0;i< provincie.markers.length;i++) {
                var marker = provincie.markers[i];
                marker.setMap(null);
              }
            }
          }
          else {
            var index = -1;
            for(i = 0;i<gemeenteMarkers.length;i++) {
              if(currentlySelectedPolygon.gemeente == gemeenteMarkers[i].name) {
                index = i;
              }
            }
            if(index>-1) {
              var gemeente = gemeenteMarkers[index];
              for(i = 0;i< gemeente.markers.length;i++) {
                var marker = gemeente.markers[i];
                marker.setMap(null);
              }
            }
          }
        }
      }

      function switchVisibilityMarkers() {
        if(markersVisible) {
          hideMarkers();
          markersVisible = false;
        }
        else {
          showMarkers(currentlySelectedPolygon.gemeente, currentlySelectedPolygon.provincie);
          markersVisible = true;
        }
      }

      // On click for the dropdown
      $(function(){
        $("#menuTime").on('click', 'li a', function() {
            $("#dropdownMenu2").val($(this).text());
            $("#dropdownMenu2").html($(this).text() + ' <span class="caret"></span>');
            switchPolygonViewing($(this).text());
        });
    });

      //google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<style>
#map-canvas {
    height: 600px;
    width: 1100px; 
    margin-left: auto; 
    margin-right: auto; 
}

.jumbotronPadding{
    padding: 30px 15px;
    margin-top: 80px;
}
.navbar-nav li input {
 line-height: 20px;
}
#infoWindow{
width:250px;
height:175px;
}
</style>

<!--<div id='editor'></div>-->


<body onload="initialize()">
    <div class="container">
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
              <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">OpenOV Visualization</a>
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                  <ul class="nav navbar-nav">
                    <li>
                      <a href="index.html">Home</a>
                    </li>
                    <li>
                      <a href="Choropleths.html">Choropleths</a>
                    </li>
                    <li>
                    </li>
                  </ul>
                </div>
        </nav>

        <div class="container col-centered">
            <div class="jumbotron jumbotronPadding">
                <h1>OpenOV visualization</h1>
                <h4>Authors: Friso Abcouwer (4019873) & Marijn Goedegebure (4013484)</h4>
            </div>
        </div>
        <div class="row">
          <div class="col-md-8">
          </div>
          <div class="col-md-2">
            <div class="btn-group">
              <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-expanded="true">
              Provincies
              <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" id="menuTime" role="menu" aria-labelledby="dropdownMenu2">
                  <li role = "presentation"><a role="menuitem" tabindex="-1">Gemeenten</a></li>
                  <li role = "presentation"><a role="menuitem" tabindex="-1">Provincies</a></li>
                  <li role = "presentation"><a role="menuitem" tabindex="-1">None</a></li>
              </ul>
            </div>
          </div>
          <div class="col-md-2">
            <div class="checkbox">
              <label for="filterUnfulfilled">
                  <input class="autosubmit" id="filterUnfulfilled" value="true" type="checkbox" onchange="switchVisibilityMarkers()" checked>
                  Show/Hide markers
              </label>
            </div>
          </div>
        </div>
        <div class="row">
            <div id="map-canvas"></div>
        </div>
    </div>
    <div id="footer" style="height:50px">
    </div>
</body>
</html>