<!DOCTYPE html>
<html>
<head>
    <title>Dota Visualization</title>
    <meta charset="utf-8">
    <link href=bootstrap-3.1.1-dist/css/bootstrap.css rel=stylesheet media="screen">

</head>
<style>
#editor
{
    font: 10px sans-serif;
}

#code
{
    font: 10px sans-serif;
}

.axis text {
    font: 10px sans-serif;
}

.axis path,
.axis line {
    fill: none;
    stroke: #000;
}

.outer {
    fill: none;
    stroke: #cc2316;
}

.arc path {
    stroke: #fff;
}

text {     
    font-family: sans-serif;     
    font-size: 15px;
    fill: black; 
}

body {
  font: 10px sans-serif;
}

div.tooltip {
    position: absolute;         
    text-align: center;         
    width: 100px;                    
    height: 120px;                   
    padding: 2px;               
    font: 12px sans-serif;      
    background: lightsteelblue; 
    border: 0px;        
    border-radius: 8px;         
    pointer-events: none;

}


</style>
<div class="row">
    <div class="col-lg-6" id ="headerLeft">
    </div>
    <div class="col-lg-6" id ="headerRight">
        <div class="dropdown">
          <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
            Select from here
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" id="menu" role="menu" aria-labelledby="dropdownMenu1">
          </ul>
        </div>
    </div>
</div>



<div class="row">
    <div class="col-lg-6" id ="svg1"></div>
    <!--<div class="col-md-4" id ="editor"></div>-->
    <div class="col-lg-6" id ="svg2"></div>
</div>

<div class="row">
    <div class="col-lg-6" id ="svg3"></div>
    <!--<div class="col-md-4" id ="editor"></div>-->
    <div class="col-lg-6" id ="svg4"></div>
</div>



<!--<div id='editor'></div>-->


<body>

    <script src=D3/d3.min.js></script>
    <script src=jquery-2.1.1.js></script>
    <script src=bootstrap-3.1.1-dist/js/bootstrap.min.js></script>
    <script src=jquery.csv-0.71.js></script>

    <script>

    var dataFileName = "ResultGeneral.csv";
    // Read the data file
    $(document).ready(function() {
        $.ajax({
            type: "GET",
            url: dataFileName,
            dataType: "text",
            success: function(data) {processData(data);}
         });
    });

    // Process data from resultgeneral into dropdown
    function processData(allText) {
        var parsedInput = $.csv.toArrays(allText);
        fillDropDown(parsedInput);
    }

    function clickMenuItem() {
        console.log("Menu item clicked!");
        //$('#dropdownMenu1').
    }

    function fillDropDown(parsedInput) {
        var menu = '';
        for(var i=1; i<parsedInput.length; i++) {
            menu += '<li role="presentation">';
            // onclick="clickMenuItem();"
            menu += '<a role="menuitem" tabindex="-1">';
            menu += parsedInput[i][0];
            menu += '</a></li>';
        }
        menu += '</li>';
        menu += '</ul>';
        $('#menu').html(menu);
    }

    $(function(){
        $(".dropdown-menu").on('click', 'li a', function(){
            console.log("menu clicked");
          $("#dropdownMenu1").val($(this).text());
          $("#dropdownMenu1").html($(this).text() + ' <span class="caret"></span>');

          // Do other stuff that is neccesary to change the d3 view below
        });
    });

    // Create the margin and size of the canvas
    var margin = {top: 25, right: 25, bottom: 25, left: 25};
    width = 700 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;


    // In order for the margins to work we need to append a "g" (graphic) element to our svg
    var svg = d3.select("#svg1").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    //X and Y axis
    var tiers = ["Normal", "High", "Very High", "Pro"];

    var x = d3.scale.ordinal()
        .domain(tiers)
        .rangeRoundBands([0, width], 0.2);
    var y = d3.scale.linear()
        .domain([0, 100])
        .rangeRound([height,0]);
    d3.select("#svg1").style("background-color", "aliceblue");

    barChart();
    pieChart();

    function pieChart() {
        radius = Math.min(width, height) / 2;

        var totalMatches = 0;

        var div = d3.select("body").append("div")   
            .attr("class", "tooltip")               
            .style("opacity", 0);

        d3.select("#svg3").style("background-color", "aliceblue");

        var svg3 = d3.select("#svg3").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Load data: filter only overall stats
        d3.csv("ResultGeneral.csv", function(error, data) {
            data = data.filter(function(d){
                if(d.Tier == "Overall") { return d; }
            });
            var name, count;
            data.forEach(function(d) {
                d.count = +((+d.Wins) + (+d.Losses));
                totalMatches += +d.count;
            });

                // Make the pie chart
            var arc = d3.svg.arc()
                .innerRadius(radius - 10)
                .outerRadius(0);

            
            var pie = d3.layout.pie()
                .sort(null)
                .value(function(d) { return d.count; });

            // Easy colors accessible via a 20-step ordinal scale
            var color = d3.scale.category20();

            // Set up groups
            var arcs = svg3.selectAll("g.arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
                .on("mouseover", function (d) {
                    var percentage = Math.round(d.data.count/totalMatches * 10000) / 100;
                    var winrate = Math.round(d.data.Winrate * 10000) / 100;
                    var tooltip = d.data.Strategy + ".<br> Played in " + d.data.count + " of " + totalMatches + " matches (" + percentage 
                        + "%).<br> Winrate: " + winrate + "%.";
                    div.transition()        
                        .duration(200)      
                        .style("opacity", .9);  
                    div.html(tooltip)
                        .style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px")
                        .style("opacity", 1);
                })
                .on("mouseout", function () {
                    div.transition()        
                        .duration(500)      
                        .style("opacity", 0);
                });

            // Draw arc paths
            arcs.append("path")
                .attr("fill", function (d, i) {
                return color(i);
            })
                .attr("d", arc);

            // Labels
            arcs.append("text")
                .attr("transform", function (d) {
                return "translate(" + arc.centroid(d) + ")";
            })
                .attr("text-anchor", "middle")
                .text(function (d) {
                return d.data.Strategy;
            });
        });
        console.log("Done pie chart");
    }

    function barChart() {
        var totalMatches;
        var barData = [];
        d3.csv("ResultGeneral.csv", function(data) {
            var name = "";
            var count;
            var counter = 0;
            data.forEach(function(d) {
                if(name == d.Strategy) {
                }
                else if(name == "") {
                    name = d.Strategy;
                    barData[counter] = [0, 0, 0, 0, 0];
                }
                else {
                    counter++;
                    name = d.Strategy;
                    barData[counter] = [0, 0, 0, 0, 0];
                }
                if(d.Tier == "Overall") {
                    barData[counter][4] = d.Winrate*100;
                }
                else if(d.Tier == "Pro") {
                    barData[counter][3] = d.Winrate*100;
                }
                else if(d.Tier == "VeryHigh") {
                    barData[counter][2] = d.Winrate*100;
                }
                else if(d.Tier == "High") {
                    barData[counter][1] = d.Winrate*100;
                }
                else{
                    barData[counter][0] = d.Winrate*100;
                }
            });

            // Start definition of second chart
            d3.select("#svg2").style("background-color", "aliceblue");

            var svg2 = d3.select("#svg2").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x2 = d3.scale.ordinal()
                .domain(tiers)
                .rangeRoundBands([0, width], 0.2);
            var y2 = d3.scale.linear()
                .domain([0, 100])
                .rangeRound([height,0]);

            var groupColor = d3.scale.category10()
            var xAxis2 = d3.svg.axis()
                .scale(x2)
                .orient('bottom');
            var yAxis2 = d3.svg.axis()
                .scale(y2)
                .orient('left');

            var dataT = d3.transpose(barData);
            var tier2 = svg2.selectAll('g')
                .data(dataT)
                .enter()
                .append('g');
            var groups2 = barData.length;

            tier2.selectAll('rect')
            .data(function (d) {return d;}) //here we are binding the tier list to children 
            .enter()
            .append('rect')
            .attr('x', function (d, i, mainIndex) { return x(tiers[mainIndex]) + i * x.rangeBand() / groups2; })
            .attr('y', function (d) {return y(d) })
            .attr('width', function () {return x.rangeBand() / groups2; })
            .attr('height', function (d) {return height - y(d);})
            .attr('fill', function (d, i) {return groupColor(i);})

            svg2.append('g')
            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + (height) + ')').call(xAxis2)
            .append("text")
            .attr("class", "label")
            .attr("x", width-20)
            .attr("y", -6)
            .text("Tier");

            svg2.append("g")
            .attr("class", "y axis")
            .call(yAxis2)
            .append("text")
            .attr("class", "label")
            .attr("x", 10)
            .attr("y", 10)
            .text("Winrate");

            console.log("Done bar chart");


        });
    }
    </script>
</body>
</html>